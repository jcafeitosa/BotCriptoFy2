# Workflow de Trabalho com M√≥dulos - BotCriptoFy2

## üéØ Guia Pr√°tico de Desenvolvimento

### 1. Antes de Modificar Qualquer M√≥dulo (OBRIGAT√ìRIO)

#### Passo 1: An√°lise de Depend√™ncias (Regra 53 - AGENTS.md)

```bash
# 1. Encontrar quem usa este m√≥dulo
grep -r "from '@/modules/nome-do-modulo" backend/src --include="*.ts" | cut -d: -f1 | sort -u

# 2. Encontrar o que este m√≥dulo usa
grep "from '@/modules/" backend/src/modules/nome-do-modulo --include="*.ts" -r

# 3. Usar o comando personalizado
/dev-analyze-dependencies src/modules/nome-do-modulo
```

#### Passo 2: Verificar Tier do M√≥dulo

Consulte `MODULES_ANALYSIS.md` para identificar:
- **Tier 1**: Impacto CR√çTICO (todos dependem)
- **Tier 2**: Impacto ALTO (trading afetado)
- **Tier 3-6**: Impacto M√âDIO/BAIXO (localizado)

#### Passo 3: Planejar Mudan√ßas em Cascata

```markdown
# Exemplo: Modificando `market-data`

Dependentes diretos:
- orders (usa pricing)
- positions (usa currentPrice)
- strategies (usa historical data)
- risk (usa volatility)
- bots (usa real-time data)
- banco (usa asset prices)

A√ß√£o: Atualizar TODOS os 6 m√≥dulos se alterar interface
```

---

### 2. Adicionando um Novo M√≥dulo

#### Template de Cria√ß√£o:

```bash
# 1. Criar estrutura
mkdir -p backend/src/modules/novo-modulo/{routes,services,schema,types,middleware}

# 2. Criar arquivos base
touch backend/src/modules/novo-modulo/index.ts
touch backend/src/modules/novo-modulo/routes/novo-modulo.routes.ts
touch backend/src/modules/novo-modulo/services/novo-modulo.service.ts
touch backend/src/modules/novo-modulo/schema/novo-modulo.schema.ts
touch backend/src/modules/novo-modulo/types/novo-modulo.types.ts

# 3. Usar comando personalizado
/project-init novo-modulo
```

#### Estrutura Padr√£o:

```
novo-modulo/
‚îú‚îÄ‚îÄ index.ts              # Exporta√ß√µes principais
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Rotas Elysia
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # L√≥gica de neg√≥cio
‚îú‚îÄ‚îÄ schema/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Schema Drizzle
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # TypeScript types
‚îî‚îÄ‚îÄ middleware/
    ‚îî‚îÄ‚îÄ index.ts          # Middlewares espec√≠ficos
```

#### Checklist de Integra√ß√£o:

```typescript
// 1. Exportar rotas em index.ts
export { novoModuloRoutes } from './routes';

// 2. Adicionar em backend/src/index.ts
import { novoModuloRoutes } from './modules/novo-modulo';

app.use(novoModuloRoutes);

// 3. Adicionar tag Swagger
tags: [
  { name: 'Novo M√≥dulo', description: 'Descri√ß√£o do m√≥dulo' }
]

// 4. Validar com CTO
/agent-cto-validate
```

---

### 3. Modificando M√≥dulos Existentes

#### Tier 1 (Infraestrutura) - EXTREMO CUIDADO

```bash
# Exemplo: Modificando `auth`

‚ö†Ô∏è ATEN√á√ÉO: 29 m√≥dulos dependem de auth!

Checklist:
1. [ ] Ler AGENTS.md (53 Regras)
2. [ ] An√°lise de depend√™ncias completa
3. [ ] Criar branch espec√≠fica
4. [ ] Testes ANTES (coverage ‚â•95%)
5. [ ] Modifica√ß√£o m√≠nima poss√≠vel
6. [ ] Backward compatibility OBRIGAT√ìRIA
7. [ ] Testes DEPOIS (todos os 29 m√≥dulos)
8. [ ] Code review (2+ revisores)
9. [ ] Deploy gradual (canary)
```

#### Tier 2 (Trading) - ALTO CUIDADO

```bash
# Exemplo: Modificando `exchanges`

‚ö†Ô∏è ATEN√á√ÉO: 7 m√≥dulos de trading dependem!

Checklist:
1. [ ] An√°lise de depend√™ncias
2. [ ] Testes unit√°rios (coverage ‚â•90%)
3. [ ] Testes de integra√ß√£o (CCXT)
4. [ ] /exchange-test para validar
5. [ ] Atualizar m√≥dulos dependentes:
   - market-data
   - orders
   - positions
   - strategies
   - risk
   - bots
   - banco
6. [ ] Code review (1+ revisor)
```

#### Tier 3-6 (Outros) - CUIDADO NORMAL

```bash
# Exemplo: Modificando `marketing`

Checklist:
1. [ ] An√°lise de depend√™ncias
2. [ ] Testes unit√°rios (coverage ‚â•80%)
3. [ ] Atualizar m√≥dulos dependentes (se houver)
4. [ ] Code review
```

---

### 4. Ordem de Desenvolvimento para Novos Features

#### Feature: "Novo Tipo de Bot"

```mermaid
graph LR
    A[1. market-data] --> B[2. strategies]
    B --> C[3. risk]
    C --> D[4. bots]
    D --> E[5. social-trading]
```

**Explica√ß√£o:**
1. Garantir que `market-data` fornece dados necess√°rios
2. Criar estrat√©gia em `strategies`
3. Definir limites de risco em `risk`
4. Implementar bot em `bots`
5. Integrar com `social-trading` (opcional)

#### Feature: "Novo Gateway de Pagamento"

```mermaid
graph LR
    A[1. financial] --> B[2. subscriptions]
    B --> C[3. affiliate]
```

**Explica√ß√£o:**
1. Adicionar gateway em `financial`
2. Integrar com `subscriptions`
3. Configurar comiss√µes em `affiliate`

---

### 5. Debugging de Problemas

#### Problema: "Erro ao criar ordem"

```bash
# Caminho de debugging (Tier 2):

1. Verificar `auth` (usu√°rio autenticado?)
   ‚îî‚îÄ logs em /var/log/botcripto/auth.log

2. Verificar `exchanges` (exchange conectada?)
   ‚îî‚îÄ GET /exchanges/:id
   ‚îî‚îÄ logs em /var/log/botcripto/exchanges.log

3. Verificar `market-data` (pre√ßo dispon√≠vel?)
   ‚îî‚îÄ GET /market-data/ticker?symbol=BTC/USDT
   ‚îî‚îÄ logs em /var/log/botcripto/market-data.log

4. Verificar `orders` (cria√ß√£o de ordem)
   ‚îî‚îÄ logs em /var/log/botcripto/orders.log
   ‚îî‚îÄ PostgreSQL: SELECT * FROM orders WHERE status='rejected'

5. Verificar `audit` (rastreamento)
   ‚îî‚îÄ SELECT * FROM audit_logs WHERE entity_type='order'
```

#### Problema: "Performance lenta"

```bash
# Identificar m√≥dulo lento:

1. Prometheus metrics
   ‚îî‚îÄ GET /metrics
   ‚îî‚îÄ Procurar por http_request_duration_seconds

2. Winston logs
   ‚îî‚îÄ grep "duration" /var/log/botcripto/*.log | sort -t: -k4 -n

3. PostgreSQL slow queries
   ‚îî‚îÄ SELECT * FROM pg_stat_statements ORDER BY mean_exec_time DESC

4. Redis slow log
   ‚îî‚îÄ redis-cli SLOWLOG GET 10

# M√≥dulos comuns de gargalo:
- market-data (TimescaleDB queries)
- risk (c√°lculos complexos)
- social-trading (queries join-heavy)
```

---

### 6. Testes por Tier

#### Tier 1 (Infraestrutura)

```bash
# Coverage m√≠nimo: 95%

bun test src/modules/auth --coverage
bun test src/modules/security --coverage
bun test src/modules/audit --coverage
bun test src/modules/tenants --coverage
bun test src/modules/users --coverage

# Testes cr√≠ticos:
- Auth flow completo
- RBAC permissions
- Audit logging
- Tenant isolation
```

#### Tier 2 (Trading)

```bash
# Coverage m√≠nimo: 90%

bun test src/modules/exchanges --coverage
bun test src/modules/market-data --coverage
bun test src/modules/orders --coverage
bun test src/modules/positions --coverage
bun test src/modules/strategies --coverage
bun test src/modules/risk --coverage
bun test src/modules/bots --coverage

# Testes cr√≠ticos:
- CCXT integration
- Order execution
- Position tracking
- Risk calculations
- Backtesting accuracy
```

#### Tier 3-6 (Outros)

```bash
# Coverage m√≠nimo: 80%

bun test src/modules/financial --coverage
bun test src/modules/banco --coverage
bun test src/modules/social-trading --coverage
# ... outros m√≥dulos
```

---

### 7. Comandos √öteis por M√≥dulo

#### Trading Modules:

```bash
# Testar exchange
/exchange-test Binance BTC/USDT

# Validar estrat√©gia
/strategy-validate minha-estrategia

# Executar backtest
/backtest-run --strategy=ma-crossover --symbol=BTC/USDT --start=2024-01-01

# Verificar risco
GET /risk/portfolio
GET /risk/var
```

#### Operacional:

```bash
# Health check completo
/project-health-check

# Code review
/dev-code-review src/modules/marketing

# An√°lise de depend√™ncias
/dev-analyze-dependencies src/modules/sales/services/deals.service.ts
```

---

### 8. Padr√µes de C√≥digo por M√≥dulo

#### Services (L√≥gica de Neg√≥cio):

```typescript
// backend/src/modules/*/services/*.service.ts

import { db } from '@/db';
import { ServiceResponse } from '@/types';
import { logAuditEvent } from '@/modules/audit/services/audit-logger.service';

export class NomeService {
  /**
   * Descri√ß√£o da fun√ß√£o
   * @param {Type} param - Descri√ß√£o do par√¢metro
   * @returns {ServiceResponse<Type>} Resultado da opera√ß√£o
   */
  async metodo(param: Type): Promise<ServiceResponse<Type>> {
    try {
      // 1. Valida√ß√£o
      if (!param) {
        return { success: false, error: 'Par√¢metro inv√°lido' };
      }

      // 2. L√≥gica de neg√≥cio
      const result = await db.query(/* ... */);

      // 3. Audit logging (se necess√°rio)
      await logAuditEvent({
        action: 'nome.metodo',
        entityType: 'nome',
        entityId: result.id,
      });

      // 4. Retorno
      return { success: true, data: result };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : 'Erro desconhecido',
      };
    }
  }
}
```

#### Routes (Endpoints):

```typescript
// backend/src/modules/*/routes/*.routes.ts

import { Elysia, t } from 'elysia';
import { nomeService } from '../services/nome.service';

export const nomeRoutes = new Elysia({ prefix: '/nome' })
  .get(
    '/',
    async ({ query }) => {
      const result = await nomeService.listar(query);
      return result;
    },
    {
      detail: {
        tags: ['Nome'],
        summary: 'Listar itens',
        description: 'Retorna lista de itens com pagina√ß√£o',
      },
      query: t.Object({
        page: t.Optional(t.Number()),
        limit: t.Optional(t.Number()),
      }),
    }
  );
```

---

### 9. Migra√ß√£o de Depend√™ncias

#### Cen√°rio: Trocar `market-data` source

```bash
# Antes: CoinGecko
# Depois: Binance WebSocket

M√≥dulos afetados:
1. market-data (implementa√ß√£o)
2. orders (pricing)
3. positions (currentPrice)
4. strategies (signals)
5. risk (volatility)
6. bots (execution)
7. banco (portfolio pricing)

Plano:
1. [ ] Criar nova implementa√ß√£o em market-data
2. [ ] Feature flag para switch gradual
3. [ ] Testes A/B (CoinGecko vs Binance)
4. [ ] Atualizar consumidores (1 por vez)
5. [ ] Monitorar m√©tricas
6. [ ] Deprecar CoinGecko ap√≥s 30 dias
```

---

### 10. Checklist de Finaliza√ß√£o

Ao completar modifica√ß√µes em um m√≥dulo:

```markdown
## Checklist Final

### C√≥digo
- [ ] TypeScript: Zero erros
- [ ] ESLint: Zero warnings
- [ ] Prettier: Formatado
- [ ] Coverage: ‚â• threshold (95%/90%/80%)
- [ ] Documenta√ß√£o: JSDoc completa

### Depend√™ncias
- [ ] An√°lise de depend√™ncias completa
- [ ] M√≥dulos dependentes atualizados
- [ ] Backward compatibility verificada
- [ ] Breaking changes documentadas

### Testes
- [ ] Testes unit√°rios passando
- [ ] Testes de integra√ß√£o passando
- [ ] Testes E2E passando (se aplic√°vel)
- [ ] Performance tests (se Tier 1-2)

### Seguran√ßa
- [ ] Nenhum secret exposto
- [ ] Valida√ß√£o de entrada (Zod)
- [ ] SQL injection prevenido
- [ ] XSS prevenido
- [ ] CSRF tokens (se aplic√°vel)

### Operacional
- [ ] Logs adequados (Winston)
- [ ] Metrics expostas (Prometheus)
- [ ] Audit events registrados
- [ ] Error handling completo

### Deploy
- [ ] CI/CD verde
- [ ] Migrations executadas
- [ ] Rollback plan definido
- [ ] Monitoring configurado

### Documenta√ß√£o
- [ ] CHANGELOG.md atualizado
- [ ] API docs atualizadas (Swagger)
- [ ] README atualizado (se novo m√≥dulo)
- [ ] MODULES_ANALYSIS.md atualizado (se nova depend√™ncia)
```

---

## üöÄ Exemplos Pr√°ticos

### Exemplo 1: Adicionar Nova Exchange

```bash
# M√≥dulo afetado: exchanges

1. Verificar suporte CCXT
   ‚îî‚îÄ https://github.com/ccxt/ccxt#supported-cryptocurrency-exchange-markets

2. Adicionar em exchanges/services/exchange.service.ts
   ‚îî‚îÄ Criar m√©todo connectNovaExchange()

3. Testes
   ‚îî‚îÄ /exchange-test NovaExchange BTC/USDT

4. Atualizar dependentes (SE necess√°rio)
   ‚îî‚îÄ market-data (se nova API)
   ‚îî‚îÄ orders (se nova sintaxe)

5. Documenta√ß√£o
   ‚îî‚îÄ Adicionar em SUPPORTED_EXCHANGES.md
```

### Exemplo 2: Adicionar Nova Estrat√©gia

```bash
# M√≥dulo afetado: strategies

1. Criar em strategies/services/strategies/nova-estrategia.ts

2. Registrar em strategies/services/strategy-registry.ts

3. Backtest
   ‚îî‚îÄ /backtest-run --strategy=nova-estrategia --symbol=BTC/USDT

4. Valida√ß√£o
   ‚îî‚îÄ /strategy-validate nova-estrategia

5. Integra√ß√£o com bots (opcional)
   ‚îî‚îÄ Adicionar em bots/types/bot-strategies.ts
```

### Exemplo 3: Adicionar Novo Tipo de Wallet

```bash
# M√≥dulo afetado: banco

1. Atualizar schema
   ‚îî‚îÄ banco/schema/wallet.schema.ts
   ‚îî‚îÄ Adicionar novo tipo: 'lending' | 'yield'

2. Servi√ßos
   ‚îî‚îÄ banco/services/wallet.service.ts
   ‚îî‚îÄ Criar createLendingWallet()

3. Routes
   ‚îî‚îÄ banco/routes/wallet.routes.ts
   ‚îî‚îÄ POST /banco/wallets/lending

4. Dependentes
   ‚îî‚îÄ portfolio (adicionar c√°lculo de yield)
   ‚îî‚îÄ financial (adicionar categoria)

5. Testes
   ‚îî‚îÄ bun test src/modules/banco --coverage
```

---

*√öltima atualiza√ß√£o: 2025-10-17*
*Baseado em: AGENTS.md (53 Regras de Ouro)*
