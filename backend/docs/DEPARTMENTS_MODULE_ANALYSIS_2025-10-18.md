# üìã Departments Module - An√°lise Completa
**Data**: 2025-10-18
**Auditor**: Agente-CTO
**Protocolo**: AGENTS.md v1.1.0

---

## üéØ Sum√°rio Executivo

### Estado Atual
- ‚úÖ **Estrutura**: M√≥dulo bem organizado com 3 servi√ßos e 3 rotas
- ‚úÖ **Schema**: Tabelas bem definidas com rela√ß√µes corretas
- ‚ö†Ô∏è **Funcionalidades**: ~40% implementado (b√°sico CRUD apenas)
- ‚ùå **Testes**: 0% coverage (CR√çTICO)
- ‚ö†Ô∏è **Seguran√ßa**: Autentica√ß√£o presente, autoriza√ß√£o ausente
- ‚ö†Ô∏è **Performance**: Sem cache, sem otimiza√ß√µes
- ‚ö†Ô∏è **Valida√ß√£o**: Valida√ß√£o m√≠nima com Elysia t.Object

### Arquivos do M√≥dulo
```
backend/src/modules/departments/
‚îú‚îÄ‚îÄ index.ts (17 linhas) - Exports
‚îú‚îÄ‚îÄ schema/
‚îÇ   ‚îî‚îÄ‚îÄ departments.schema.ts (88 linhas) - 2 tabelas, relations
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ department.types.ts (78 linhas) - Tipos e interfaces
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ department.service.ts (204 linhas) - 7 fun√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ membership.service.ts (255 linhas) - 9 fun√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ analytics.service.ts (151 linhas) - 4 fun√ß√µes
‚îÇ   ‚îî‚îÄ‚îÄ index.ts (3 linhas)
‚îî‚îÄ‚îÄ routes/
    ‚îú‚îÄ‚îÄ department.routes.ts (235 linhas) - 8 endpoints
    ‚îú‚îÄ‚îÄ membership.routes.ts (230 linhas) - 7 endpoints
    ‚îú‚îÄ‚îÄ analytics.routes.ts (108 linhas) - 4 endpoints
    ‚îî‚îÄ‚îÄ index.ts (3 linhas)
```

**Total**: 1,372 linhas de c√≥digo

---

## üìä An√°lise de Depend√™ncias (Regra 53)

### Depend√™ncias Internas
```mermaid
graph TD
    A[departments] --> B[tenants]
    A --> C[users/auth]
    D[notifications] -.->|optional| A
    E[financial] -.->|reference| A
    F[sales] -.->|string field| A
```

### M√≥dulos que Dependem de Departments
1. **notifications** (linha 9, 20, 66, 160)
   - `notificationTemplates.departmentId` (opcional)
   - `notifications.departmentId` (opcional)
   - `notificationCampaigns.departmentId` (opcional)
   - ‚úÖ **Correto**: Rela√ß√£o opcional e bem justificada

2. **financial** (expenses, budgets, ledger)
   - `expenses.departmentId` (UUID, sem FK definida)
   - `budgets.departmentId` (UUID, sem FK definida)
   - `ledger.departmentId` (UUID, sem FK definida)
   - ‚ö†Ô∏è **PROBLEMA**: Foreign keys ausentes (integridade referencial)

3. **sales/contacts**
   - `contacts.department` (VARCHAR, n√£o √© FK)
   - ‚úÖ **Correto**: Campo de texto livre, n√£o √© rela√ß√£o

### Invas√£o de Compet√™ncias

#### ‚ùå **INVAS√ÉO IDENTIFICADA: Sales Module**
**Arquivo**: `backend/src/modules/sales/schema/contacts.schema.ts:23`
```typescript
department: varchar('department', { length: 100 })
```

**Problema**:
- Campo `department` √© string livre, n√£o relacionado √† tabela `departments`
- Permite inconsist√™ncia (typos, departamentos inexistentes)
- N√£o aproveita a estrutura organizacional do sistema

**Solu√ß√£o**:
1. **Op√ß√£o A (Recomendada)**: Converter para FK
   ```typescript
   departmentId: uuid('department_id').references(() => departments.id)
   ```
2. **Op√ß√£o B**: Manter como tag/categoria livre (se justificado)

**Decis√£o Arquitetural**: Requer ADR

#### ‚ö†Ô∏è **PROBLEMA: Financial Module**
**Arquivos**:
- `backend/src/modules/financial/schema/expenses.schema.ts`
- `backend/src/modules/financial/schema/budgets.schema.ts`
- `backend/src/modules/financial/schema/ledger.schema.ts`

**Problema**:
- Campos `departmentId` existem mas sem `.references()`
- Sem integridade referencial no banco
- Sem valida√ß√£o autom√°tica de departamento v√°lido

**Impacto**: üî¥ **ALTO**
- Dados √≥rf√£os poss√≠veis
- Relat√≥rios incorretos
- Auditoria comprometida

**Solu√ß√£o**: Adicionar FKs nas migrations
```typescript
departmentId: uuid('department_id')
  .references(() => departments.id, { onDelete: 'set null' })
```

---

## üîç Gaps Identificados

### 1. ‚ùå Funcionalidades Ausentes (Cr√≠tico)

#### 1.1 Hierarquia de Departamentos
**Documenta√ß√£o**: `docs/departments/README.md` menciona 9 departamentos + CEO
**Problema**: Sem suporte a sub-departamentos ou hierarquia

**Impacto**:
- Imposs√≠vel modelar estruturas organizacionais complexas
- Sem escalabilidade para empresas maiores

**Solu√ß√£o**:
```typescript
// Adicionar ao schema
export const departments = pgTable('departments', {
  // ... campos existentes
  parentId: uuid('parent_id').references((): AnyPgColumn => departments.id),
  level: integer('level').default(0), // 0 = root, 1 = sub, etc
  path: text('path'), // Materialized path: /ceo/financial/billing
});
```

**Endpoints Necess√°rios**:
- `GET /api/departments/:id/children` - Listar sub-departamentos
- `GET /api/departments/:id/hierarchy` - √Årvore completa
- `GET /api/departments/:id/ancestors` - Departamentos pais
- `POST /api/departments/:id/move` - Mover na hierarquia

#### 1.2 Permiss√µes Granulares
**Problema**: Apenas 3 roles (manager, member, viewer)
**Necess√°rio**: Sistema de permiss√µes espec√≠ficas

**Solu√ß√£o**:
```typescript
export const departmentPermissions = pgTable('department_permissions', {
  id: uuid('id').primaryKey().defaultRandom(),
  membershipId: uuid('membership_id').references(() => departmentMembers.id),
  resource: text('resource').notNull(), // 'budgets', 'reports', 'members'
  action: text('action').notNull(), // 'create', 'read', 'update', 'delete'
  granted: boolean('granted').default(true),
});
```

**Endpoints**:
- `GET /api/departments/:id/members/:userId/permissions`
- `PUT /api/departments/:id/members/:userId/permissions`
- `GET /api/departments/:id/permissions/roles` - Template de permiss√µes

#### 1.3 Workflows e Aprova√ß√µes
**Problema**: Sem sistema de aprova√ß√£o para mudan√ßas cr√≠ticas

**Casos de Uso**:
- Aprova√ß√£o para adicionar membro
- Aprova√ß√£o para mudan√ßa de role
- Aprova√ß√£o para desativar departamento

**Solu√ß√£o**:
```typescript
export const departmentApprovals = pgTable('department_approvals', {
  id: uuid('id').primaryKey().defaultRandom(),
  departmentId: uuid('department_id').references(() => departments.id),
  requestedBy: text('requested_by').references(() => users.id),
  approvedBy: text('approved_by').references(() => users.id),
  action: text('action').notNull(), // 'add_member', 'change_role', 'deactivate'
  actionData: jsonb('action_data').$type<Record<string, any>>(),
  status: text('status').notNull().default('pending'), // pending, approved, rejected
  requestedAt: timestamp('requested_at').defaultNow(),
  resolvedAt: timestamp('resolved_at'),
});
```

#### 1.4 Auditoria de A√ß√µes
**Problema**: Sem logs de a√ß√µes departamentais

**Solu√ß√£o**: Integra√ß√£o com m√≥dulo `audit`
```typescript
// Em cada a√ß√£o cr√≠tica
await auditLogger.log({
  action: 'department.member.added',
  departmentId,
  userId: assignedUser.id,
  performedBy: currentUser.id,
  metadata: { role, assignedBy },
});
```

#### 1.5 Budgets e Aloca√ß√£o
**Problema**: Relacionamento com `financial` mas sem endpoints de budget

**Solu√ß√£o**: Endpoints de integra√ß√£o
- `GET /api/departments/:id/budget/current`
- `GET /api/departments/:id/budget/history`
- `GET /api/departments/:id/expenses/summary`
- `PUT /api/departments/:id/budget/allocate`

#### 1.6 KPIs por Departamento
**Problema**: Analytics b√°sico, sem KPIs espec√≠ficos por tipo

**Solu√ß√£o**: KPIs contextuais
```typescript
interface DepartmentKPIs {
  // Comum a todos
  memberCount: number;
  activeRate: number;

  // Espec√≠ficos por tipo
  financial?: {
    budgetUtilization: number;
    pendingApprovals: number;
    expensesByCategory: Record<string, number>;
  };
  marketing?: {
    campaignsActive: number;
    leadConversion: number;
    roi: number;
  };
  sales?: {
    dealsInPipeline: number;
    conversionRate: number;
    revenue: number;
  };
  // ... outros
}
```

**Endpoints**:
- `GET /api/departments/:id/kpis`
- `GET /api/departments/:id/kpis/trends?period=30d`

#### 1.7 Templates de Departamento
**Problema**: Criar departamento requer configura√ß√£o manual

**Solu√ß√£o**: Templates pr√©-configurados
```typescript
export const departmentTemplates = pgTable('department_templates', {
  id: uuid('id').primaryKey().defaultRandom(),
  type: text('type').notNull(),
  name: text('name').notNull(),
  defaultSettings: jsonb('default_settings'),
  defaultRoles: jsonb('default_roles'), // roles e permiss√µes padr√£o
  requiredIntegrations: jsonb('required_integrations'), // ['financial', 'audit']
});
```

**Endpoints**:
- `GET /api/departments/templates` - Listar templates
- `POST /api/departments/from-template` - Criar de template
- `GET /api/departments/templates/:type` - Template espec√≠fico

#### 1.8 Integra√ß√£o com Agents
**Problema**: Documenta√ß√£o menciona agentes por departamento, mas sem implementa√ß√£o

**Solu√ß√£o**: Relacionamento com m√≥dulo `agents`
```typescript
export const departmentAgents = pgTable('department_agents', {
  id: uuid('id').primaryKey().defaultRandom(),
  departmentId: uuid('department_id').references(() => departments.id),
  agentId: uuid('agent_id'), // Reference to agents module
  isActive: boolean('is_active').default(true),
  configuration: jsonb('configuration'),
});
```

**Endpoints**:
- `GET /api/departments/:id/agents`
- `POST /api/departments/:id/agents/:agentId/activate`
- `DELETE /api/departments/:id/agents/:agentId`
- `GET /api/departments/:id/agents/:agentId/logs`

#### 1.9 Notifica√ß√µes Departamentais
**Problema**: Relacionamento com notifications existe, mas sem endpoints

**Solu√ß√£o**:
- `GET /api/departments/:id/notifications` - Notifica√ß√µes do departamento
- `POST /api/departments/:id/notifications/broadcast` - Enviar para todos
- `GET /api/departments/:id/notifications/templates` - Templates do departamento

#### 1.10 Relat√≥rios Avan√ßados
**Problema**: Analytics b√°sico, sem relat√≥rios executivos

**Endpoints Necess√°rios**:
- `GET /api/departments/:id/reports/performance` - Performance geral
- `GET /api/departments/:id/reports/comparison` - Comparar com outros
- `GET /api/departments/:id/reports/trends` - Tend√™ncias temporais
- `GET /api/departments/:id/reports/export?format=pdf|excel` - Exportar

---

### 2. ‚ùå Seguran√ßa (Cr√≠tico)

#### 2.1 Autoriza√ß√£o Ausente
**Problema**: Apenas `sessionGuard`, sem verifica√ß√£o de permiss√µes

**Impacto**: üî¥ **CR√çTICO**
- Qualquer usu√°rio autenticado pode gerenciar qualquer departamento
- Sem verifica√ß√£o de tenant (multi-tenancy quebrado)
- Sem verifica√ß√£o de role (manager vs member vs viewer)

**Solu√ß√£o**:
```typescript
// Criar middleware de autoriza√ß√£o
export const departmentAuthGuard = (requiredRole?: MemberRole) => {
  return async (context: Context) => {
    const { user, params } = context;
    const departmentId = params.id;

    // Verificar se usu√°rio pertence ao departamento
    const membership = await isUserMemberOfDepartment(user.id, departmentId);
    if (!membership) {
      throw new ForbiddenError('User not member of department');
    }

    // Verificar role se especificado
    if (requiredRole) {
      const role = await getMemberRole(user.id, departmentId);
      const roleHierarchy = { viewer: 0, member: 1, manager: 2 };
      if (roleHierarchy[role] < roleHierarchy[requiredRole]) {
        throw new ForbiddenError(`Requires ${requiredRole} role`);
      }
    }

    return context;
  };
};
```

**Aplicar em Rotas**:
```typescript
.use(sessionGuard)
.use(departmentAuthGuard('manager')) // Apenas managers
.put('/:id', async ({ params, body }) => {
  // ...
})
```

#### 2.2 Valida√ß√£o de Tenant
**Problema**: Endpoints n√£o validam tenantId do usu√°rio

**Solu√ß√£o**:
```typescript
// Em getAllDepartments
export async function getAllDepartments(filter?: DepartmentFilter, userTenantId?: string) {
  const conditions = [];

  // SEMPRE filtrar por tenant do usu√°rio
  if (userTenantId) {
    conditions.push(eq(departments.tenantId, userTenantId));
  }

  // ... resto do c√≥digo
}
```

#### 2.3 Rate Limiting
**Problema**: Sem prote√ß√£o contra abuso de APIs

**Solu√ß√£o**:
```typescript
import { rateLimiting } from '@/modules/rate-limiting';

export const departmentRoutes = new Elysia({ prefix: '/api/departments' })
  .use(sessionGuard)
  .use(rateLimiting({ max: 100, window: '15m' }))
  // ... rotas
```

#### 2.4 Input Sanitization
**Problema**: Valida√ß√£o m√≠nima, sem sanitiza√ß√£o

**Solu√ß√£o**: Adicionar Zod schemas
```typescript
import { z } from 'zod';

export const createDepartmentSchema = z.object({
  tenantId: z.string().uuid(),
  name: z.string().min(3).max(100).trim(),
  slug: z.string().regex(/^[a-z0-9-]+$/).toLowerCase(),
  description: z.string().max(500).optional(),
  type: z.enum(['ceo', 'financial', /* ... */]),
  settings: z.record(z.any()).optional(),
  metadata: z.record(z.any()).optional(),
});
```

#### 2.5 SQL Injection Prevention
**Problema**: Drizzle protege, mas queries din√¢micas podem ser vulner√°veis

**An√°lise**: ‚úÖ C√≥digo atual seguro (usa Drizzle query builder)
**Recomenda√ß√£o**: Manter padr√£o, evitar `db.execute()` com strings

#### 2.6 RBAC Integration
**Problema**: Sem integra√ß√£o com sistema RBAC do projeto

**Solu√ß√£o**: Verificar permiss√µes via RBAC
```typescript
import { checkPermission } from '@/modules/security/services/rbac.service';

// Antes de a√ß√µes cr√≠ticas
await checkPermission(userId, 'departments', 'delete');
```

---

### 3. ‚ö†Ô∏è Performance

#### 3.1 Sem Cache
**Problema**: Todas queries v√£o ao banco

**Solu√ß√£o**: Implementar cache com Redis
```typescript
import { redisCache } from '@/lib/redis';

export async function getDepartmentById(id: string) {
  const cacheKey = `department:${id}`;

  // Tentar cache primeiro
  const cached = await redisCache.get(cacheKey);
  if (cached) return JSON.parse(cached);

  // Buscar do banco
  const department = await db.select()...;

  // Armazenar em cache (TTL: 5 minutos)
  await redisCache.setex(cacheKey, 300, JSON.stringify(department));

  return department;
}
```

**Cache Keys**:
- `department:{id}` - Departamento individual
- `department:slug:{tenantId}:{slug}` - Por slug
- `departments:tenant:{tenantId}` - Lista por tenant
- `department:{id}:members` - Membros
- `department:{id}:stats` - Estat√≠sticas

#### 3.2 N+1 Queries
**Problema**: getDepartmentMembers pode gerar m√∫ltiplas queries

**An√°lise Atual**: ‚úÖ Usa JOIN, sem N+1
**Recomenda√ß√£o**: Manter padr√£o

#### 3.3 √çndices Ausentes
**Problema**: Schema sem √≠ndices customizados

**Solu√ß√£o**:
```typescript
export const departments = pgTable('departments', {
  // ... campos
}, (table) => ({
  tenantIdIdx: index('departments_tenant_id_idx').on(table.tenantId),
  typeIdx: index('departments_type_idx').on(table.type),
  slugIdx: index('departments_slug_idx').on(table.slug),
  tenantSlugIdx: index('departments_tenant_slug_idx').on(table.tenantId, table.slug),
  isActiveIdx: index('departments_is_active_idx').on(table.isActive),
}));

export const departmentMembers = pgTable('department_members', {
  // ... campos
}, (table) => ({
  departmentIdIdx: index('dept_members_dept_id_idx').on(table.departmentId),
  userIdIdx: index('dept_members_user_id_idx').on(table.userId),
  roleIdx: index('dept_members_role_idx').on(table.role),
  isActiveIdx: index('dept_members_is_active_idx').on(table.isActive),
}));
```

#### 3.4 Pagina√ß√£o Ausente
**Problema**: Endpoints retornam todos os registros

**Solu√ß√£o**:
```typescript
export interface PaginationParams {
  page?: number;
  limit?: number;
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
}

export async function getAllDepartments(
  filter?: DepartmentFilter,
  pagination?: PaginationParams
) {
  const { page = 1, limit = 50, sortBy = 'createdAt', sortOrder = 'desc' } = pagination || {};
  const offset = (page - 1) * limit;

  // ... query com .limit(limit).offset(offset)

  const [totalResult] = await db.select({ count: count() })...;

  return {
    data: results,
    pagination: {
      page,
      limit,
      total: totalResult.count,
      totalPages: Math.ceil(totalResult.count / limit),
    },
  };
}
```

#### 3.5 Bulk Operations
**Problema**: Sem suporte a opera√ß√µes em lote

**Endpoints Necess√°rios**:
- `POST /api/departments/bulk/create` - Criar m√∫ltiplos
- `POST /api/departments/:id/members/bulk/add` - Adicionar m√∫ltiplos membros
- `DELETE /api/departments/bulk/delete` - Deletar m√∫ltiplos
- `PUT /api/departments/bulk/update` - Atualizar m√∫ltiplos

---

### 4. ‚ùå Valida√ß√£o

#### 4.1 Valida√ß√£o Fraca
**Problema**: Valida√ß√£o apenas com Elysia t.Object

**Solu√ß√£o**: Migrar para Zod
```typescript
// types/department.validation.ts
import { z } from 'zod';

export const departmentTypeSchema = z.enum([
  'ceo', 'financial', 'marketing', 'sales',
  'security', 'sac', 'audit', 'documents',
  'configurations', 'subscriptions'
]);

export const createDepartmentSchema = z.object({
  tenantId: z.string().uuid({ message: 'Invalid tenant ID format' }),
  name: z.string()
    .min(3, 'Name must be at least 3 characters')
    .max(100, 'Name too long')
    .trim(),
  slug: z.string()
    .regex(/^[a-z0-9-]+$/, 'Slug must contain only lowercase letters, numbers, and hyphens')
    .min(3)
    .max(50)
    .toLowerCase()
    .transform(s => s.trim()),
  description: z.string().max(500).optional(),
  type: departmentTypeSchema,
  settings: z.record(z.any()).optional().default({}),
  metadata: z.record(z.any()).optional().default({}),
}).strict(); // N√£o permite campos extras

export const updateDepartmentSchema = createDepartmentSchema.partial().omit({ tenantId: true });

export const addMemberSchema = z.object({
  userId: z.string().uuid(),
  role: z.enum(['manager', 'member', 'viewer']),
}).strict();
```

**Aplicar em Routes**:
```typescript
import { createDepartmentSchema } from '../types/department.validation';

.post('/', async ({ body }) => {
  // Validar com Zod
  const validated = createDepartmentSchema.parse(body);
  const department = await createDepartment(validated);
  // ...
})
```

#### 4.2 Regras de Neg√≥cio
**Valida√ß√µes Ausentes**:

1. **Limite de Departamentos por Tenant**
   ```typescript
   // Verificar limite antes de criar
   const count = await db.select({ count: count() })
     .from(departments)
     .where(eq(departments.tenantId, tenantId));

   if (count[0].count >= MAX_DEPARTMENTS_PER_TENANT) {
     throw new ConflictError('Department limit reached');
   }
   ```

2. **Tipo √önico por Tenant** (CEO deve ser √∫nico)
   ```typescript
   if (type === 'ceo') {
     const existing = await db.select()
       .from(departments)
       .where(and(
         eq(departments.tenantId, tenantId),
         eq(departments.type, 'ceo')
       ));

     if (existing.length > 0) {
       throw new ConflictError('CEO department already exists');
     }
   }
   ```

3. **Manager Obrigat√≥rio**
   ```typescript
   // Ao desativar √∫ltimo manager
   const managers = await db.select({ count: count() })
     .from(departmentMembers)
     .where(and(
       eq(departmentMembers.departmentId, departmentId),
       eq(departmentMembers.role, 'manager'),
       eq(departmentMembers.isActive, true)
     ));

   if (managers[0].count <= 1) {
     throw new ConflictError('Department must have at least one active manager');
   }
   ```

4. **Valida√ß√£o de Ciclo (Hierarquia)**
   ```typescript
   async function validateNoCycle(departmentId: string, newParentId: string): Promise<boolean> {
     // Verificar se newParentId est√° na √°rvore de filhos de departmentId
     // Implementa√ß√£o com recursive CTE ou DFS
   }
   ```

#### 4.3 Mensagens de Erro
**Problema**: Mensagens gen√©ricas

**Solu√ß√£o**: Mensagens descritivas e internacionalizadas
```typescript
export const errorMessages = {
  DEPARTMENT_NOT_FOUND: {
    en: 'Department not found',
    pt: 'Departamento n√£o encontrado',
  },
  SLUG_ALREADY_EXISTS: {
    en: 'A department with this slug already exists',
    pt: 'J√° existe um departamento com este identificador',
  },
  // ... mais mensagens
};
```

---

### 5. ‚ùå Testes (CR√çTICO)

**Status Atual**: 0% coverage
**Requerido**: ‚â•80% coverage

#### 5.1 Testes Unit√°rios Necess√°rios

**Arquivo**: `backend/src/modules/departments/__tests__/department.service.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'bun:test';
import {
  getAllDepartments,
  getDepartmentById,
  createDepartment,
  updateDepartment,
  deleteDepartment,
} from '../services/department.service';

describe('Department Service', () => {
  beforeEach(async () => {
    // Setup test database
  });

  afterEach(async () => {
    // Cleanup
  });

  describe('getAllDepartments', () => {
    it('should return all departments', async () => {
      // ...
    });

    it('should filter by tenantId', async () => {
      // ...
    });

    it('should filter by type', async () => {
      // ...
    });

    it('should filter by isActive', async () => {
      // ...
    });
  });

  describe('getDepartmentById', () => {
    it('should return department when exists', async () => {
      // ...
    });

    it('should throw NotFoundError when not exists', async () => {
      // ...
    });
  });

  describe('createDepartment', () => {
    it('should create department successfully', async () => {
      // ...
    });

    it('should throw ConflictError when slug exists', async () => {
      // ...
    });

    it('should throw ConflictError when CEO already exists', async () => {
      // ...
    });
  });

  // ... mais testes
});
```

#### 5.2 Testes de Integra√ß√£o

**Arquivo**: `backend/src/modules/departments/__tests__/department.routes.integration.test.ts`

```typescript
import { describe, it, expect } from 'bun:test';
import { app } from '@/index';

describe('Department Routes Integration', () => {
  describe('POST /api/departments', () => {
    it('should create department with valid data', async () => {
      const response = await app.handle(
        new Request('http://localhost/api/departments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${validToken}`,
          },
          body: JSON.stringify({
            tenantId: 'test-tenant',
            name: 'Test Department',
            slug: 'test-dept',
            type: 'financial',
          }),
        })
      );

      expect(response.status).toBe(200);
      const data = await response.json();
      expect(data.success).toBe(true);
      expect(data.data.name).toBe('Test Department');
    });

    it('should return 401 without authentication', async () => {
      // ...
    });

    it('should return 403 without permission', async () => {
      // ...
    });

    it('should return 400 with invalid data', async () => {
      // ...
    });
  });

  // ... mais testes
});
```

#### 5.3 Coverage Targets
- **Statements**: ‚â•80%
- **Branches**: ‚â•75%
- **Functions**: ‚â•80%
- **Lines**: ‚â•80%

---

### 6. üìù Documenta√ß√£o

#### 6.1 JSDoc Ausente
**Problema**: Documenta√ß√£o m√≠nima

**Solu√ß√£o**: JSDoc completo
```typescript
/**
 * Get all departments with optional filtering
 *
 * @param {DepartmentFilter} [filter] - Optional filter criteria
 * @param {string} [filter.tenantId] - Filter by tenant ID
 * @param {DepartmentType} [filter.type] - Filter by department type
 * @param {boolean} [filter.isActive] - Filter by active status
 * @param {PaginationParams} [pagination] - Pagination parameters
 *
 * @returns {Promise<PaginatedResult<Department>>} Paginated list of departments
 *
 * @throws {ValidationError} If filter parameters are invalid
 * @throws {DatabaseError} If database query fails
 *
 * @example
 * ```typescript
 * const departments = await getAllDepartments(
 *   { tenantId: 'abc', isActive: true },
 *   { page: 1, limit: 20 }
 * );
 * ```
 */
export async function getAllDepartments(
  filter?: DepartmentFilter,
  pagination?: PaginationParams
): Promise<PaginatedResult<Department>> {
  // ...
}
```

#### 6.2 README Ausente
**Criar**: `backend/src/modules/departments/README.md`

Conte√∫do:
- Vis√£o geral do m√≥dulo
- Estrutura de arquivos
- Como usar (exemplos)
- API endpoints
- Tipos e interfaces
- Regras de neg√≥cio
- FAQ

#### 6.3 Swagger/Scalar Tags
**Status**: ‚úÖ Presente (tags: 'Departments', 'Department Membership', 'Department Analytics')
**Melhoria**: Adicionar mais exemplos e descri√ß√µes

#### 6.4 Changelog
**Criar**: `backend/src/modules/departments/CHANGELOG.md`

---

### 7. üîÑ Melhorias de L√≥gica

#### 7.1 Transa√ß√µes
**Problema**: Opera√ß√µes n√£o s√£o transacionais

**Solu√ß√£o**:
```typescript
import { db } from '@/db';

export async function createDepartmentWithManager(
  departmentData: CreateDepartmentRequest,
  managerId: string
) {
  return await db.transaction(async (tx) => {
    // Criar departamento
    const [department] = await tx.insert(departments)
      .values(departmentData)
      .returning();

    // Adicionar manager
    await tx.insert(departmentMembers)
      .values({
        departmentId: department.id,
        userId: managerId,
        role: 'manager',
        assignedBy: managerId,
      });

    return department;
  });
}
```

#### 7.2 Soft Delete
**Problema**: Delete permanente

**Solu√ß√£o**: Adicionar soft delete
```typescript
// Schema
export const departments = pgTable('departments', {
  // ... campos existentes
  deletedAt: timestamp('deleted_at'),
  deletedBy: text('deleted_by').references(() => users.id),
});

// Service
export async function softDeleteDepartment(id: string, userId: string) {
  const [deleted] = await db
    .update(departments)
    .set({
      deletedAt: new Date(),
      deletedBy: userId,
      isActive: false,
    })
    .where(eq(departments.id, id))
    .returning();

  return deleted;
}

export async function restoreDepartment(id: string) {
  const [restored] = await db
    .update(departments)
    .set({
      deletedAt: null,
      deletedBy: null,
      isActive: true,
    })
    .where(eq(departments.id, id))
    .returning();

  return restored;
}
```

#### 7.3 Event System
**Problema**: Sem notifica√ß√£o de mudan√ßas

**Solu√ß√£o**: Event emitter
```typescript
import { EventEmitter } from 'events';

export const departmentEvents = new EventEmitter();

// Emitir eventos
export async function createDepartment(data: CreateDepartmentRequest) {
  const department = await db.insert(departments)...;

  departmentEvents.emit('department.created', {
    departmentId: department.id,
    tenantId: department.tenantId,
    type: department.type,
  });

  return department;
}

// Listeners em outros m√≥dulos
departmentEvents.on('department.created', async (event) => {
  // Criar templates de notifica√ß√£o
  // Criar budget padr√£o
  // Notificar admins
});
```

#### 7.4 Versioning
**Problema**: Sem hist√≥rico de mudan√ßas

**Solu√ß√£o**: Tabela de hist√≥rico
```typescript
export const departmentHistory = pgTable('department_history', {
  id: uuid('id').primaryKey().defaultRandom(),
  departmentId: uuid('department_id').references(() => departments.id),
  changedBy: text('changed_by').references(() => users.id),
  changeType: text('change_type').notNull(), // 'created', 'updated', 'deleted'
  oldData: jsonb('old_data'),
  newData: jsonb('new_data'),
  changedAt: timestamp('changed_at').defaultNow(),
});
```

---

### 8. üìä Endpoints Avan√ßados Necess√°rios

#### 8.1 Busca e Filtros
```
GET /api/departments/search?q={query}&type={type}&tenant={id}
GET /api/departments/filter?isActive=true&hasMembers=true
```

#### 8.2 Exporta√ß√£o
```
GET /api/departments/export?format=csv|json|excel
GET /api/departments/:id/export?format=pdf
```

#### 8.3 Duplica√ß√£o
```
POST /api/departments/:id/duplicate
POST /api/departments/:id/clone-to-tenant/:tenantId
```

#### 8.4 M√©tricas Temporais
```
GET /api/departments/:id/metrics/daily?start={date}&end={date}
GET /api/departments/:id/metrics/weekly
GET /api/departments/:id/metrics/monthly
```

#### 8.5 Compara√ß√£o
```
GET /api/departments/compare?ids={id1,id2,id3}&metric={kpi}
GET /api/departments/:id/compare-with/:otherId
```

#### 8.6 Webhooks
```
POST /api/departments/:id/webhooks
GET /api/departments/:id/webhooks
DELETE /api/departments/:id/webhooks/:webhookId
```

---

## üìà Plano de Implementa√ß√£o

### Fase 1: Funda√ß√£o (Prioridade CR√çTICA)
**Estimativa**: 1-2 dias

1. ‚úÖ Adicionar testes unit√°rios (coverage ‚â•80%)
2. ‚úÖ Implementar autoriza√ß√£o e permiss√µes
3. ‚úÖ Adicionar valida√ß√£o Zod
4. ‚úÖ Implementar √≠ndices no banco
5. ‚úÖ Adicionar soft delete
6. ‚úÖ Implementar cache b√°sico

### Fase 2: Funcionalidades Core (Prioridade ALTA)
**Estimativa**: 2-3 dias

1. ‚úÖ Hierarquia de departamentos
2. ‚úÖ Permiss√µes granulares
3. ‚úÖ Workflows de aprova√ß√£o
4. ‚úÖ Auditoria de a√ß√µes
5. ‚úÖ Pagina√ß√£o em todos endpoints
6. ‚úÖ Bulk operations

### Fase 3: Integra√ß√µes (Prioridade M√âDIA)
**Estimativa**: 1-2 dias

1. ‚úÖ Integra√ß√£o com m√≥dulo Financial
2. ‚úÖ Integra√ß√£o com m√≥dulo Agents
3. ‚úÖ Integra√ß√£o com m√≥dulo Notifications
4. ‚úÖ Integra√ß√£o com m√≥dulo Audit
5. ‚úÖ Event system
6. ‚úÖ Corrigir FKs em outros m√≥dulos

### Fase 4: Analytics Avan√ßado (Prioridade M√âDIA)
**Estimativa**: 2-3 dias

1. ‚úÖ KPIs por tipo de departamento
2. ‚úÖ Relat√≥rios avan√ßados
3. ‚úÖ Compara√ß√£o entre departamentos
4. ‚úÖ Trends e previs√µes
5. ‚úÖ Exporta√ß√£o de dados
6. ‚úÖ Dashboards

### Fase 5: Features Avan√ßadas (Prioridade BAIXA)
**Estimativa**: 2-3 dias

1. ‚úÖ Templates de departamento
2. ‚úÖ Duplica√ß√£o e clonagem
3. ‚úÖ Webhooks
4. ‚úÖ Versioning de mudan√ßas
5. ‚úÖ Busca avan√ßada
6. ‚úÖ AI insights

---

## üéØ M√©tricas de Sucesso

### Antes
- ‚ùå 0% test coverage
- ‚ùå 0 endpoints avan√ßados
- ‚ùå Sem autoriza√ß√£o
- ‚ùå Sem cache
- ‚ùå Sem valida√ß√£o robusta
- ‚ö†Ô∏è ~40% funcionalidades implementadas

### Depois (Target)
- ‚úÖ ‚â•80% test coverage
- ‚úÖ +30 endpoints avan√ßados
- ‚úÖ Autoriza√ß√£o completa (RBAC)
- ‚úÖ Cache implementado (Redis)
- ‚úÖ Valida√ß√£o completa (Zod)
- ‚úÖ ~95% funcionalidades implementadas

---

## üìù Decis√µes Arquiteturais Requeridas

### ADR-005: Hierarquia de Departamentos
**Decis√£o**: Implementar hierarquia com parent_id + materialized path
**Alternativas**: Closure table, nested sets
**Justificativa**: Melhor performance para queries, simplicidade

### ADR-006: Sistema de Permiss√µes
**Decis√£o**: Tabela separada department_permissions
**Alternativas**: JSONB em departmentMembers, integra√ß√£o RBAC
**Justificativa**: Granularidade e auditoria

### ADR-007: Foreign Keys em Financial
**Decis√£o**: Adicionar FKs com onDelete: 'set null'
**Alternativas**: onDelete: 'cascade', no FK
**Justificativa**: Preservar hist√≥rico financeiro

### ADR-008: Sales.contacts.department
**Decis√£o**: Manter como string, adicionar sugest√µes via API
**Alternativas**: Converter para FK
**Justificativa**: Flexibilidade para departamentos externos

---

## üîç Conclus√£o

O m√≥dulo **departments** est√° funcional mas b√°sico (~40% completo). Requer:

### Cr√≠tico (URGENTE)
1. ‚úÖ Testes (0% ‚Üí ‚â•80%)
2. ‚úÖ Autoriza√ß√£o e seguran√ßa
3. ‚úÖ Valida√ß√£o robusta
4. ‚úÖ √çndices de performance
5. ‚úÖ Corrigir FKs em financial

### Alto (Pr√≥xima Sprint)
1. ‚úÖ Hierarquia de departamentos
2. ‚úÖ Permiss√µes granulares
3. ‚úÖ Workflows de aprova√ß√£o
4. ‚úÖ Integra√ß√µes (agents, notifications)

### M√©dio (2-3 Sprints)
1. ‚úÖ Analytics avan√ßado
2. ‚úÖ KPIs espec√≠ficos por tipo
3. ‚úÖ Relat√≥rios executivos

### Baixo (Backlog)
1. ‚úÖ Templates
2. ‚úÖ Webhooks
3. ‚úÖ AI insights

**Total de Melhorias**: ~60 itens identificados
**Estimativa Total**: 8-13 dias de desenvolvimento
**ROI**: Alto (m√≥dulo central para multi-tenancy e organiza√ß√£o)

---

**Aprovado para implementa√ß√£o**: ‚úÖ
**Revisor**: Agente-CTO
**Data**: 2025-10-18
**Vers√£o**: 1.0.0
